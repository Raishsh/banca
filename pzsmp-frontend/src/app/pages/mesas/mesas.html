<div class="mesas-container">
  <div class="page-header">
    <div class="header-text">
      <h1>Gerenciamento de Mesas</h1>
      <p>
        Clique em uma mesa para ver detalhes, fazer um pedido ou uma reserva.
      </p>
    </div>
  </div>

  <div class="mesas-grid">
    <div
      *ngFor="let mesa of listaMesas"
      class="mesa-card"
      (click)="abrirModal(mesa)"
      [ngClass]="{
        'status-livre': mesa.status === 'LIVRE',
        'status-ocupada': mesa.status === 'OCUPADA',
        'status-reservada': mesa.status === 'RESERVADA'
      }"
    >
      <div class="mesa-numero">Mesa {{ mesa.numero }}</div>
      <div class="mesa-status">{{ mesa.status }}</div>
      <div class="mesa-capacidade">{{ mesa.capacidade }} lugares</div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mesaSelecionada">
  <div class="modal-content-large">
    <button class="btn-fechar" (click)="fecharModal()">X</button>
    <h2>Mesa {{ mesaSelecionada.numero }}</h2>

    <div class="modal-nav">
      <button
        (click)="modalView = 'novoPedido'"
        [class.active]="modalView === 'novoPedido'"
      >
        Novo Pedido / Adicionar Itens
      </button>
      <button
        (click)="modalView = 'pedidos'"
        [class.active]="modalView === 'pedidos'"
      >
        Ver Pedidos Ativos
      </button>
      <button
        (click)="modalView = 'reserva'"
        [class.active]="modalView === 'reserva'"
      >
        Reservar
      </button>
    </div>

    <div class="modal-body">
      <div *ngIf="modalView === 'novoPedido'" class="novo-pedido-view">
        <div class="cardapio-coluna">
          <h4>Cardápio</h4>
          <div class="filtros-cardapio">
            <button
              *ngFor="let tipo of tiposDeProduto"
              (click)="filtrarCardapio(tipo)"
              [class.active]="filtroCardapioAtual === tipo"
            >
              {{ formatarNomeFiltro(tipo) }}
            </button>
          </div>
          <div class="lista-produtos-cardapio">
            <div
              class="item-cardapio"
              *ngFor="let produto of cardapioFiltrado"
              (click)="adicionarAoPedido(produto)"
            >
              {{ produto.nome }} - R$ {{ produto.preco.toFixed(2) }}
            </div>
          </div>
        </div>
        <div class="pedido-coluna">
          <h4>Itens a Adicionar</h4>
          <div *ngIf="novoPedidoItens.length > 0; else pedidoVazio">
            <div *ngFor="let item of novoPedidoItens" class="item-pedido-atual">
              <div class="item-info">
                <span
                  >{{ item.quantidade }}x {{ item.produto.nome
                  }}<span *ngIf="item.tamanho" class="tamanho-item">
                    ({{ item.tamanho }})</span
                  ></span
                >
                <span
                  >R$
                  {{
                    (
                      (item.tamanho === "P" && item.produto.precoPequeno
                        ? item.produto.precoPequeno
                        : item.tamanho === "M" && item.produto.precoMedio
                        ? item.produto.precoMedio
                        : item.tamanho === "G" && item.produto.precoGrande
                        ? item.produto.precoGrande
                        : item.produto.preco) * item.quantidade
                    ).toFixed(2)
                  }}</span
                >
              </div>
              <button
                class="btn-remover-item"
                (click)="removerDoPedido(item)"
                title="Remover Item"
              >
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
            <hr />
            <div class="total-pedido">
              <strong
                >Total a Adicionar: R$ {{ totalNovoPedido.toFixed(2) }}</strong
              >
            </div>
          </div>
          <ng-template #pedidoVazio
            ><p>Clique nos itens do cardápio para adicionar.</p></ng-template
          >
          <button class="btn-finalizar-pedido" (click)="finalizarPedido()">
            {{
              pedidosDaMesa.length > 0
                ? "Adicionar ao Pedido Existente"
                : "Criar Novo Pedido"
            }}
          </button>
        </div>
      </div>

      <div *ngIf="modalView === 'pedidos'" class="pedidos-view">
        <h4>Pedidos Ativos da Mesa {{ mesaSelecionada?.numero }}</h4>
        <div *ngIf="pedidosDaMesa.length > 0; else nenhumPedido" class="pedidos-lista">
          <div *ngFor="let pedido of pedidosDaMesa" class="pedido-card">
            <div class="pedido-header">
              <span class="pedido-id">Pedido #{{ pedido.idPedido }}</span>
              <span class="pedido-status" [ngClass]="'status-' + pedido.status.toLowerCase()">{{ pedido.status }}</span>
            </div>
            <div class="pedido-detalhes">
              <p><strong>Data:</strong> {{ pedido.data | date: 'dd/MM/yyyy HH:mm' }}</p>
              <p><strong>Total:</strong> R$ {{ pedido.total.toFixed(2) }}</p>
              <p *ngIf="pedido.cliente"><strong>Cliente:</strong> {{ pedido.cliente.nome }}</p>
            </div>
            <div class="pedido-itens">
              <strong>Itens:</strong>
              <ul>
                <li *ngFor="let item of pedido.itens">
                  {{ item.quantidade }}x {{ item.nomeProduto }}<span *ngIf="item.tamanho" class="tamanho-item"> ({{ item.tamanho }})</span> - R$ {{ (item.precoUnitario * item.quantidade).toFixed(2) }}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <ng-template #nenhumPedido>
          <p class="pedido-vazio-mensagem">Nenhum pedido ativo para esta mesa.</p>
        </ng-template>
      </div>

      <div *ngIf="modalView === 'reserva'" class="reserva-view">
        <h4>Gerenciar Reserva</h4>
        <div *ngIf="mesaSelecionada?.status === 'RESERVADA'; else formReserva" class="reserva-ativa">
          <div *ngIf="reservasDaMesa.length > 0" class="reserva-card">
            <div *ngFor="let reserva of reservasDaMesa" class="reserva-detalhes">
              <p><strong>Nome:</strong> {{ reserva.nomeReserva }}</p>
              <p><strong>Pessoas:</strong> {{ reserva.numPessoas }}</p>
              <p *ngIf="reserva.observacoes"><strong>Observações:</strong> {{ reserva.observacoes }}</p>
              <p><strong>Data:</strong> {{ reserva.dataReserva | date: 'dd/MM/yyyy HH:mm' }}</p>
              <button class="btn-cancelar-reserva" (click)="cancelarReserva(reserva.idReserva)">
                Cancelar Reserva
              </button>
            </div>
          </div>
        </div>
        <ng-template #formReserva>
          <p class="info-mensagem">A mesa está disponível. Preencha os dados para fazer uma reserva.</p>
          <div class="form-reserva">
            <div class="form-group">
              <label for="nomeReserva">Nome para a Reserva</label>
              <input id="nomeReserva" type="text" [(ngModel)]="novaReserva.nomeReserva" placeholder="Ex: João Silva" required>
            </div>
            <div class="form-group">
              <label for="numPessoas">Número de Pessoas</label>
              <input id="numPessoas" type="number" [(ngModel)]="novaReserva.numPessoas" placeholder="Ex: 4" required min="1">
            </div>
            <div class="form-group">
              <label for="observacoes">Observações (opcional)</label>
              <textarea id="observacoes" [(ngModel)]="novaReserva.observacoes" placeholder="Ex: Alergia a pimenta"></textarea>
            </div>
            <button class="btn-fazer-reserva" (click)="reservarMesa()">Fazer Reserva</button>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showSizeModal" (click)="fecharSizeModal()">
  <div class="modal-tamanho" (click)="$event.stopPropagation()">
    <h3>Selecione o Tamanho</h3>
    <p *ngIf="produtoParaSelecionarTamanho">
      {{ produtoParaSelecionarTamanho.nome }}
    </p>
    <div class="tamanho-opcoes">
      <button
        *ngIf="
          produtoParaSelecionarTamanho &&
          produtoParaSelecionarTamanho.precoPequeno
        "
        class="tamanho-btn"
        (click)="selecionarTamanho('P')"
      >
        P - R$ {{ produtoParaSelecionarTamanho.precoPequeno.toFixed(2) }}
      </button>
      <button
        *ngIf="
          produtoParaSelecionarTamanho &&
          produtoParaSelecionarTamanho.precoMedio
        "
        class="tamanho-btn"
        (click)="selecionarTamanho('M')"
      >
        M - R$ {{ produtoParaSelecionarTamanho.precoMedio.toFixed(2) }}
      </button>
      <button
        *ngIf="
          produtoParaSelecionarTamanho &&
          produtoParaSelecionarTamanho.precoGrande
        "
        class="tamanho-btn"
        (click)="selecionarTamanho('G')"
      >
        G - R$ {{ produtoParaSelecionarTamanho.precoGrande.toFixed(2) }}
      </button>
    </div>
    <button class="tamanho-btn-cancelar" (click)="fecharSizeModal()">
      Cancelar
    </button>
  </div>
</div>
